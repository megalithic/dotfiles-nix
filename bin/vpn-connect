#!/usr/bin/env bash

# VPN Connection Script for Cisco Secure Client
# Supports both CLI and GUI connection methods

set -euo pipefail

# Source notification helper
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/notifier"

# Default configuration
DEFAULT_VPN_URL="vpn.edge.launchdeck.tech"
DEFAULT_METHOD="gui"

# Paths to Cisco Secure Client
if [[ "$OSTYPE" == "darwin"* ]]; then
    VPNCLI="/opt/cisco/secureclient/bin/vpn"
    VPN_APP="/Applications/Cisco/Cisco Secure Client.app"
else
    VPNCLI="/opt/cisco/anyconnect/bin/vpn"
    VPN_APP=""
fi

# Color output helpers
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[INFO]${NC} $*"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $*"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $*"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $*"
}

# Show usage information
show_usage() {
    cat <<EOF
Usage: vpn-connect [OPTIONS]

Connect to Cisco Secure Client VPN using CLI or GUI method.

OPTIONS:
    -m, --method <cli|gui>     Connection method (default: $DEFAULT_METHOD)
    -u, --url <url>            VPN server URL (default: $DEFAULT_VPN_URL)
    -s, --status               Check VPN connection status
    -d, --disconnect           Disconnect from VPN
    -h, --help                 Show this help message

Long options also support = syntax:
    --method=gui --url=vpn.example.com

EXAMPLES:
    # Connect using GUI method (default)
    vpn-connect

    # Connect using CLI method (short form)
    vpn-connect -m cli

    # Connect using CLI method (long form)
    vpn-connect --method cli

    # Connect using CLI method (= syntax)
    vpn-connect --method=cli

    # Connect to custom VPN URL (short form)
    vpn-connect -u vpn.example.com

    # Connect to custom VPN URL (long form)
    vpn-connect --url vpn.example.com

    # Connect to custom VPN URL (= syntax)
    vpn-connect --url=vpn.example.com

    # Combine options (short form)
    vpn-connect -m cli -u vpn.example.com

    # Combine options (long form)
    vpn-connect --method cli --url vpn.example.com

    # Combine options (= syntax)
    vpn-connect --method=cli --url=vpn.example.com

    # Check connection status (short form)
    vpn-connect -s

    # Check connection status (long form)
    vpn-connect --status

    # Disconnect from VPN (short form)
    vpn-connect -d

    # Disconnect from VPN (long form)
    vpn-connect --disconnect

METHODS:
    gui     - Launch Cisco Secure Client GUI and open connection URL
    cli     - Use command-line interface to connect (requires credentials)

NOTES:
    - GUI method is recommended for interactive use with MFA/2FA
    - CLI method may prompt for credentials in terminal
    - VPN credentials can be stored in 1Password for future automation
EOF
}

# Check if Cisco Secure Client is installed
check_vpn_installed() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        if [[ ! -d "$VPN_APP" ]] && [[ ! -f "$VPNCLI" ]]; then
            log_error "Cisco Secure Client not found"
            log_error "Install from: https://www.cisco.com/c/en/us/support/security/anyconnect-secure-mobility-client/"
            return 1
        fi
    else
        if [[ ! -f "$VPNCLI" ]]; then
            log_error "Cisco AnyConnect VPN CLI not found at: $VPNCLI"
            return 1
        fi
    fi
    return 0
}

# Get VPN connection status
get_vpn_status() {
    if [[ ! -f "$VPNCLI" ]]; then
        log_warn "VPN CLI not found, cannot check status"
        return 1
    fi

    local status_output
    status_output=$($VPNCLI state 2>/dev/null || echo "Disconnected")

    if echo "$status_output" | grep -q "state: Connected"; then
        return 0  # Connected
    else
        return 1  # Not connected
    fi
}

# Check VPN status and display
check_status() {
    log_info "Checking VPN connection status..."

    if get_vpn_status; then
        local status_details
        status_details=$($VPNCLI state 2>/dev/null)
        log_success "VPN is connected"
        echo "$status_details"
        return 0
    else
        log_info "VPN is disconnected"
        return 1
    fi
}

# Disconnect from VPN
disconnect_vpn() {
    log_info "Disconnecting from VPN..."

    if ! get_vpn_status; then
        log_info "VPN is already disconnected"
        return 0
    fi

    if [[ -f "$VPNCLI" ]]; then
        $VPNCLI disconnect
        log_success "Disconnected from VPN"
        notify_user "VPN Disconnected" "Successfully disconnected from VPN" false normal
    else
        log_error "VPN CLI not found, cannot disconnect"
        return 1
    fi
}

# Connect using GUI method
connect_gui() {
    local vpn_url="$1"

    log_info "Launching Cisco Secure Client GUI..."
    log_info "VPN URL: $vpn_url"

    if [[ "$OSTYPE" == "darwin"* ]]; then
        # Open the application
        open "$VPN_APP"

        # Wait a moment for app to launch
        sleep 2

        # Open the connection URL (Cisco Secure Client registers vpn:// protocol)
        open "vpn://$vpn_url"

        log_success "Cisco Secure Client launched"
        log_info "Please complete authentication in the GUI"
        notify_user "VPN Connection" "Cisco Secure Client launched. Complete authentication in GUI." false normal
    else
        log_error "GUI method only supported on macOS"
        return 1
    fi
}

# Connect using CLI method
connect_cli() {
    local vpn_url="$1"

    if [[ ! -f "$VPNCLI" ]]; then
        log_error "VPN CLI not found at: $VPNCLI"
        log_error "Please install Cisco Secure Client or use --method gui"
        return 1
    fi

    log_info "Connecting to VPN via CLI..."
    log_info "VPN URL: $vpn_url"

    # Check if already connected
    if get_vpn_status; then
        log_warn "Already connected to VPN"
        log_info "Use --disconnect to disconnect first"
        return 0
    fi

    # Attempt connection (will prompt for credentials interactively)
    log_info "Starting connection (you may be prompted for credentials)..."

    if $VPNCLI -s connect "$vpn_url"; then
        log_success "Successfully connected to VPN"

        # Show connection details
        $VPNCLI state

        notify_user "VPN Connected" "Successfully connected to $vpn_url" false normal
        return 0
    else
        log_error "Failed to connect to VPN"
        notify_user "VPN Connection Failed" "Could not connect to $vpn_url" false high
        return 1
    fi
}

# Main function
main() {
    local method="$DEFAULT_METHOD"
    local vpn_url="$DEFAULT_VPN_URL"
    local action="connect"

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -m|--method)
                method="$2"
                shift 2
                ;;
            --method=*)
                method="${1#*=}"
                shift
                ;;
            -u|--url)
                vpn_url="$2"
                shift 2
                ;;
            --url=*)
                vpn_url="${1#*=}"
                shift
                ;;
            -s|--status)
                action="status"
                shift
                ;;
            -d|--disconnect)
                action="disconnect"
                shift
                ;;
            -h|--help)
                show_usage
                exit 0
                ;;
            *)
                log_error "Unknown option: $1"
                echo ""
                show_usage
                exit 1
                ;;
        esac
    done

    # Validate method
    if [[ "$method" != "cli" && "$method" != "gui" ]]; then
        log_error "Invalid method: $method (must be 'cli' or 'gui')"
        exit 1
    fi

    # Check installation
    if ! check_vpn_installed; then
        exit 1
    fi

    # Execute action
    case "$action" in
        status)
            check_status
            ;;
        disconnect)
            disconnect_vpn
            ;;
        connect)
            if [[ "$method" == "gui" ]]; then
                connect_gui "$vpn_url"
            else
                connect_cli "$vpn_url"
            fi
            ;;
        *)
            log_error "Unknown action: $action"
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
