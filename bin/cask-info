#!/usr/bin/env bash
# Get cask info formatted for mkCask

set -euo pipefail

TOKEN="$1"
if [ -z "$TOKEN" ]; then
  echo "Usage: $0 <cask-token>" >&2
  echo "Example: $0 mailmate" >&2
  exit 1
fi

# Fetch cask JSON from Homebrew API
JSON=$(curl -fsSL "https://formulae.brew.sh/api/cask/${TOKEN}.json" 2>/dev/null)

if [ -z "$JSON" ]; then
  echo "Error: Cask '$TOKEN' not found" >&2
  exit 1
fi

# Extract and format the data
echo "$JSON" | jq -r '
  # Check if this is a PKG installer
  if (.url | endswith(".pkg")) then
    # PKG installer - no appName needed
    "    \(.token) = mkCask {",
    "      pname = \"\(.token)\";",
    "      version = \"\(.version)\";",
    "      url = \"\(.url)\";",
    "      sha256 = \"\(.sha256)\";",
    "    };"
  else
    # App archive - include appName
    "    \(.token) = mkCask {",
    "      pname = \"\(.token)\";",
    "      version = \"\(.version)\";",
    "      url = \"\(.url)\";",
    "      sha256 = \"\(.sha256)\";",
    (if .artifacts[0].app then "      appName = \"\(.artifacts[0].app[0])\";" else "      # appName = \"\(.token).app\"; # Adjust if needed" end),
    "    };"
  end
'
